# Test suite for iterator functionality
# Run with: ruff test-run tests/iterators_test.ruff

test_group "Iterator Methods" {
    test "filter returns only matching elements" {
        numbers := [1, 2, 3, 4, 5, 6]
        even := numbers.filter(func(n) { return n % 2 == 0 }).collect()
        assert_equal(len(even), 3)
        assert_contains(even, 2)
        assert_contains(even, 4)
        assert_contains(even, 6)
    }
    
    test "map transforms all elements" {
        numbers := [1, 2, 3]
        doubled := numbers.map(func(n) { return n * 2 }).collect()
        assert_equal(len(doubled), 3)
        assert_equal(doubled[0], 2)
        assert_equal(doubled[1], 4)
        assert_equal(doubled[2], 6)
    }
    
    test "take limits number of results" {
        numbers := [1, 2, 3, 4, 5]
        first_two := numbers.take(2).collect()
        assert_equal(len(first_two), 2)
        assert_equal(first_two[0], 1)
        assert_equal(first_two[1], 2)
    }
    
    test "chaining filter and map works correctly" {
        numbers := [1, 2, 3, 4, 5, 6]
        result := numbers
            .filter(func(n) { return n > 3 })
            .map(func(n) { return n * 10 })
            .collect()
        assert_equal(len(result), 3)
        assert_equal(result[0], 40)
        assert_equal(result[1], 50)
        assert_equal(result[2], 60)
    }
    
    test "chaining with take limits correctly" {
        numbers := [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
        result := numbers
            .filter(func(n) { return n % 2 == 1 })  # Odds: 1,3,5,7,9
            .take(3)                                  # Take 3
            .map(func(n) { return n + 10 })          # Add 10
            .collect()
        assert_equal(len(result), 3)
        assert_equal(result[0], 11)  # 1 + 10
        assert_equal(result[1], 13)  # 3 + 10
        assert_equal(result[2], 15)  # 5 + 10
    }
    
    test "filter with no matches returns empty array" {
        numbers := [1, 3, 5, 7]
        even := numbers.filter(func(n) { return n % 2 == 0 }).collect()
        assert_equal(len(even), 0)
    }
    
    test "take more than length returns all elements" {
        numbers := [1, 2, 3]
        result := numbers.take(10).collect()
        assert_equal(len(result), 3)
    }
    
    test "empty array iteration works" {
        numbers := []
        result := numbers.filter(func(n) { return n > 0 }).collect()
        assert_equal(len(result), 0)
    }
    
    test "string filtering works" {
        words := ["a", "ab", "abc", "abcd"]
        long_words := words.filter(func(w) { return len(w) > 2 }).collect()
        assert_equal(len(long_words), 2)
        assert_contains(long_words, "abc")
        assert_contains(long_words, "abcd")
    }
    
    test "complex chaining with multiple filter and map" {
        numbers := [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
        # First collect the even numbers
        even := numbers.filter(func(n) { return n % 2 == 0 }).collect()
        # Then square and filter
        result := even
            .map(func(n) { return n * n })           # Square: 4,16,36,64,100
            .filter(func(n) { return n < 50 })       # Under 50: 4,16,36
            .take(2)                                  # First 2: 4,16
            .collect()
        assert_equal(len(result), 2)
        assert_equal(result[0], 4)
        assert_equal(result[1], 16)
    }
}
