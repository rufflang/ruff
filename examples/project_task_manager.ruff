#!/usr/bin/env ruff
# Task Manager CLI - Complete Project Management Tool
# Showcases: arg_parser, JSON persistence, data structures, CRUD operations, pretty printing

DATA_FILE := "tasks.json"

# Task structure: { id, title, description, status, priority, created, due }

parser := arg_parser()
parser.add_argument("action", type="string", help="Action: add, list, complete, delete, show, stats")
parser.add_argument("--title", "-t", type="string", help="Task title")
parser.add_argument("--description", "-d", type="string", help="Task description")
parser.add_argument("--priority", "-p", type="string", default="medium", help="Priority: low, medium, high, urgent")
parser.add_argument("--due", type="string", help="Due date (YYYY-MM-DD)")
parser.add_argument("--id", type="int", help="Task ID")
parser.add_argument("--status", "-s", type="string", help="Filter by status: pending, completed, all")
parser.add_argument("--json", "-j", type="bool", help="Output as JSON")

args := parser.parse()

# Load tasks from file
func load_tasks() {
    result := read_file(DATA_FILE)
    match result {
        case Ok(content): {
            if length(content) == 0 {
                return []
            }
            parsed := from_json(content)
            match parsed {
                case Ok(tasks): return tasks
                case Err(error): {
                    print("Warning: Could not parse tasks file, starting fresh")
                    return []
                }
            }
        }
        case Err(error): {
            # File doesn't exist, return empty array
            return []
        }
    }
}

# Save tasks to file
func save_tasks(tasks) {
    json_str := to_json(tasks)
    result := write_file(DATA_FILE, json_str)
    match result {
        case Ok(_): return true
        case Err(error): {
            print("Error saving tasks: " + error)
            return false
        }
    }
}

# Generate next task ID
func next_id(tasks) {
    if length(tasks) == 0 {
        return 1
    }
    max_id := 0
    for task in tasks {
        if task._id > max_id {
            max_id = task._id
        }
    }
    return max_id + 1
}

# Add new task
func add_task(tasks, title, description, priority, due_date) {
    if title == null or length(title) == 0 {
        print("âŒ Error: Task title is required")
        print("Usage: ruff run project_task_manager.ruff add --title \"Task name\" [--description \"Details\"] [--priority high] [--due 2026-12-31]")
        return false
    }
    
    task := {
        "id": next_id(tasks),
        "title": title,
        "description": description,
        "status": "pending",
        "priority": priority,
        "created": timestamp(),
        "due": due_date
    }
    
    push(tasks, task)
    
    if save_tasks(tasks) {
        print("âœ… Task #" + to_string(task._id) + " added: " + task._title)
        return true
    }
    return false
}

# List tasks
func list_tasks(tasks, status_filter, as_json) {
    filtered := []
    for task in tasks {
        if status_filter == "all" or status_filter == null or task._status == status_filter {
            push(filtered, task)
        }
    }
    
    if length(filtered) == 0 {
        print("ðŸ“‹ No tasks found")
        return null
    }
    
    if as_json {
        print(to_json(filtered))
        return null
    }
    
    # Count by status
    pending := 0
    completed := 0
    for task in filtered {
        if task._status == "pending" {
            pending = pending + 1
        } else {
            completed = completed + 1
        }
    }
    
    print("")
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print("ðŸ“‹ Task List (" + to_string(length(filtered)) + " tasks)")
    print("   Pending: " + to_string(pending) + " | Completed: " + to_string(completed))
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print("")
    
    for task in filtered {
        display_task_summary(task)
    }
}

# Display single task summary
func display_task_summary(task) {
    status_icon := "â³"
    if task._status == "completed" {
        status_icon = "âœ…"
    }
    
    priority_icon := get_priority_icon(task._priority)
    
    id_str := pad_left("#" + to_string(task._id), 5)
    print(status_icon + " " + id_str + " " + priority_icon + " " + task._title)
    
    if task._description != null and length(task._description) > 0 {
        desc_preview := truncate(task._description, 60)
        print("        â””â”€ " + desc_preview)
    }
    
    if task._due != null {
        print("        ðŸ“… Due: " + task._due)
    }
    print("")
}

# Show task details
func show_task(tasks, task_id) {
    task := find_task(tasks, task_id)
    if task == null {
        print("âŒ Task #" + to_string(task_id) + " not found")
        return null
    }
    
    print("")
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print("ðŸ“ Task #" + to_string(task._id) + " Details")
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print("")
    print("Title:       " + task._title)
    print("Status:      " + task._status)
    print("Priority:    " + task._priority + " " + get_priority_icon(task._priority))
    if task._description != null {
        print("Description: " + task._description)
    }
    print("Created:     " + format_timestamp(task._created))
    if task._due != null {
        print("Due Date:    " + task._due)
    }
    print("")
}

# Complete task
func complete_task(tasks, task_id) {
    task := find_task(tasks, task_id)
    if task == null {
        print("âŒ Task #" + to_string(task_id) + " not found")
        return false
    }
    
    if task._status == "completed" {
        print("â„¹ï¸  Task #" + to_string(task_id) + " is already completed")
        return true
    }
    
    task._status = "completed"
    
    if save_tasks(tasks) {
        print("âœ… Task #" + to_string(task_id) + " marked as complete: " + task._title)
        return true
    }
    return false
}

# Delete task
func delete_task(tasks, task_id) {
    task := find_task(tasks, task_id)
    if task == null {
        print("âŒ Task #" + to_string(task_id) + " not found")
        return false
    }
    
    # Remove task from array
    new_tasks := []
    for t in tasks {
        if t._id != task_id {
            push(new_tasks, t)
        }
    }
    
    if save_tasks(new_tasks) {
        print("ðŸ—‘ï¸  Task #" + to_string(task_id) + " deleted: " + task._title)
        return true
    }
    return false
}

# Show statistics
func show_stats(tasks) {
    if length(tasks) == 0 {
        print("ðŸ“Š No tasks to analyze")
        return null
    }
    
    # Calculate stats
    total := length(tasks)
    pending := 0
    completed := 0
    by_priority := {"low": 0, "medium": 0, "high": 0, "urgent": 0}
    
    for task in tasks {
        if task._status == "pending" {
            pending = pending + 1
        } else {
            completed = completed + 1
        }
        
        if has_key(by_priority, task._priority) {
            by_priority[task._priority] = by_priority[task._priority] + 1
        }
    }
    
    completion_rate := 0.0
    if total > 0 {
        completion_rate = round((to_float(completed) / to_float(total)) * 100.0, 1)
    }
    
    print("")
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print("ðŸ“Š Task Statistics")
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print("")
    print("Total Tasks:      " + to_string(total))
    print("Pending:          " + to_string(pending) + " (" + to_string(round(to_float(pending) / to_float(total) * 100.0, 1)) + "%)")
    print("Completed:        " + to_string(completed) + " (" + to_string(completion_rate) + "%)")
    print("")
    print("By Priority:")
    print("  ðŸ”´ Urgent:      " + to_string(by_priority._urgent))
    print("  ðŸŸ  High:        " + to_string(by_priority._high))
    print("  ðŸŸ¡ Medium:      " + to_string(by_priority._medium))
    print("  ðŸŸ¢ Low:         " + to_string(by_priority._low))
    print("")
    print("Progress: " + create_progress_bar(completion_rate, 40))
    print("")
}

# Helper functions
func find_task(tasks, task_id) {
    for task in tasks {
        if task._id == task_id {
            return task
        }
    }
    return null
}

func get_priority_icon(priority) {
    if priority == "urgent" {
        return "ðŸ”´"
    }
    if priority == "high" {
        return "ðŸŸ "
    }
    if priority == "medium" {
        return "ðŸŸ¡"
    }
    return "ðŸŸ¢"
}

func pad_left(text, width) {
    if length(text) >= width {
        return text
    }
    spaces := ""
    for i in range(0, width - length(text)) {
        spaces = spaces + " "
    }
    return spaces + text
}

func truncate(text, max_len) {
    if length(text) <= max_len {
        return text
    }
    return slice(text, 0, max_len - 3) + "..."
}

func format_timestamp(ts) {
    # Simple timestamp formatting (would be better with datetime library)
    return to_string(ts)
}

func create_progress_bar(percentage, width) {
    filled := round(percentage / 100.0 * to_float(width), 0)
    bar := "["
    for i in range(0, to_int(width)) {
        if i < filled {
            bar = bar + "â–ˆ"
        } else {
            bar = bar + "â–‘"
        }
    }
    bar = bar + "] " + to_string(percentage) + "%"
    return bar
}

# Main execution
tasks := load_tasks()

action := args._action

if action == "add" {
    add_task(tasks, args._title, args._description, args._priority, args._due)
} else if action == "list" {
    status := args._status
    if status == null {
        status = "all"
    }
    list_tasks(tasks, status, args._json)
} else if action == "show" {
    if args._id == null {
        print("âŒ Error: --id required for show command")
    } else {
        show_task(tasks, args._id)
    }
} else if action == "complete" {
    if args._id == null {
        print("âŒ Error: --id required for complete command")
    } else {
        complete_task(tasks, args._id)
    }
} else if action == "delete" {
    if args._id == null {
        print("âŒ Error: --id required for delete command")
    } else {
        delete_task(tasks, args._id)
    }
} else if action == "stats" {
    show_stats(tasks)
} else {
    print("âŒ Unknown action: " + action)
    print("")
    print("Available actions:")
    print("  add       - Add a new task")
    print("  list      - List all tasks")
    print("  show      - Show task details")
    print("  complete  - Mark task as complete")
    print("  delete    - Delete a task")
    print("  stats     - Show task statistics")
    print("")
    print("Examples:")
    print("  ruff run project_task_manager.ruff add --title \"Implement feature\" --priority high")
    print("  ruff run project_task_manager.ruff list --status pending")
    print("  ruff run project_task_manager.ruff complete --id 1")
    print("  ruff run project_task_manager.ruff stats")
}
